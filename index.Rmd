---
title: "NHP model scenarios with a run stage"
date: "Last updated: `r format(Sys.time(), '%d %b %Y at %H:%M')`"
output: html_document
---

```{r}
#| label: check-env-vars
#| results: "asis"
#| echo: false
#| message: false

required_env_vars <- c(
  "AZ_STORAGE_CONTAINER_SUPPORT",
  "AZ_STORAGE_EP",
  "AZ_TABLE_EP",
  "AZ_TABLE_NAME",
  "AZ_TENANT_ID",
  "NHP_ENCRYPT_KEY"
)

if (any(Sys.getenv(required_env_vars) == "")) {
  cat("One of the following environment variables was not set, so exiting \n\n")
  cat(paste("*", required_env_vars, collapse = "\n"), "\n\n")
  knitr::knit_exit()
}
```

```{r}
#| label: get-data
#| echo: false
#| message: false

source("R/azure.R")
source("R/wrangle.R")
source("R/table.R")
library(readr)

scheme_lookup <- Sys.getenv("AZ_STORAGE_CONTAINER_SUPPORT") |>
  get_container(container_name = _) |>
  get_scheme_lookup()

results_table <- get_table() |>
  dplyr::rename(dataset = PartitionKey)
```

## Table

Use the interactive table to check that the correct model scenarios from the New Hospitals Programme (NHP) demand model have been labelled with a run stage and have the correct sites listed.
See notes below the table.

```{r}
#| label: runs-tables
#| echo: false
#| message: false
#| page-layout: full

results_table |>
  tabulate_scenarios(scheme_lookup) |>
  create_datatable_runs()
```

## Instructions

### For MRMs

Model Relationship Managers (MRMs) should check that the correct model scenarios have been tagged with the correct 'run stage' metadata.
Contact [the Data Science team](mailto:mlcsu.su.datascience@nhs.net) to ask for updates.
This will help ensure that products such as the outputs reports and TPMA-comparison app will contain the correct information.

If missing or incorrect, schemes and/or MRMs should contact the Data Science inbox with the scheme name, scenario name, app version and run stage (currently 'initial', 'intermediate', 'final report', or 'addendum report') and non-demographic growth (NDG) variant (1, 2 or 3).

### For developers

The data presented here is stored in a lookup in Azure Table Storage given by the environment variables `AZ_TABLE_NAME` and `AZ_TABLE_EP`. Search for 'tagging-nhp-model-runs' in the NHP DS area of SharePoint for details on how to update the lookup.

## Table content

Each row is a single model run that has a run stage label.
You may have to scroll horizontally to see more information.

You can:

- search and filter across the whole tables or column-by-column
- open the NHP Outputs app pre-loaded with the selected run
- download a CSV of the currently-filtered data

Note that the column 'Results file' is the path to the 'old-style' zipped json file in the results container.
'Results dir' is the path to the directory containing the 'new-style' results (parquet files and a standalone `params.json`).

Note that 'ALL' in the 'sites' column means all sites for that scheme.
A hyphen is used where we do not have site information for that scheme.

## Schedule

This page updates automatically.
See above for the latest publish date and time.
The page is also usually updated manually when new information is available.
Please contact [the Data Science team](mailto:mlcsu.su.datascience@nhs.net) if any of the information here looks out of date and needs to be updated.

## Disclaimer

Be aware that:

- this page is intended primarily as a tool for the Data Science team's benefit
- it may not reflect the current up-to-the-moment 'truth' (check the 'last updated' datetime)
- it is not intended for purposes of governance, as schemes and model-relationship managers should keep their own records

Please contact [the Data Science team](mailto:mlcsu.su.datascience@nhs.net) if any of the information here needs to be updated.
