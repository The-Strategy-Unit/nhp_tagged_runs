---
title: "Tagged NHP model runs"
subtitle: "A simple interactive table to check metadata"
date: "Last updated: `r format(Sys.time(), '%Y-%m-%d %H:%M')`"
output: html_document
---

```{r}
#| results: "asis"
#| echo: false
#| message: false

required_env_vars <- c(
  "AZ_TENANT_ID",
  "AZ_STORAGE_EP",
  "AZ_STORAGE_CONTAINER",
  "NHP_ENCRYPT_KEY"
)

if (any(Sys.getenv(required_env_vars) == "")) {
  cat("One of the following environment variables was not set, so exiting \n\n")
  cat(paste("*", required_env_vars, collapse = "\n"), "\n\n")
  knitr::knit_exit() 
}
```

```{r}
#| label: prep-workspace
#| echo: false
#| message: false

source("R/azure.R")
source("R/wrangle.R")
source("R/table.R")

container_results <- 
  Sys.getenv("AZ_STORAGE_CONTAINER_RESULTS") |> 
  get_container(container_name = _)

container_support <- 
  Sys.getenv("AZ_STORAGE_CONTAINER_SUPPORT") |> 
  get_container(container_name = _)

result_sets  <- get_nhp_result_sets(container_results)
report_sites <- get_report_sites(container_support)
scheme_lookup <- get_scheme_lookup(container_support)

tagged_runs  <- prepare_run_stage_runs(result_sets, scheme_lookup)
```

---

```{r}
#| label: create-reactable
#| echo: false
create_reactable(dat = tagged_runs)
```

---

## Notes

Each row of the table represents a model run that we (the Data Science team) have tagged with the 'run_stage' metadata key in Azure Storage. This metadata is used to identify model runs considered as an 'initial', 'intermediate' (in development) or 'final' (used to produce final reports). The run_stage suffixes 'ndg1' and 'ndg2' indicate whether the run used non-demographic growth (NDG) variant 1 or 2.

There is functionality for you to:

- search and filter across the whole table or column-by-column
- open the NHP Outputs app pre-loaded with the selected run
- download a CSV of the currently-filtered data

Be aware that:

- this is intended primarily as a tool for the Data Science team
- it may not reflect the current up-to-the-moment 'truth' (check the 'last updated' datetime)
- it is not intended for purposes of governance, as schemes and model-relationship managers should keep their own records

Please contact [the Data Science team](mailto:mlcsu.su.datascience@nhs.net) if any of the information here needs to be updated.

---
